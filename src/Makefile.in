srcdir = @srcdir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

DISTORM3_DIR = $(top_srcdir)/distorm
VPATH = $(DISTORM3_DIR)/src:$(srcdir):$(top_srcdir)/include

CC = @CC@
CFLAGS = @CFLAGS@ @PIC_CFLAGS@ -g -I. -I$(top_srcdir)/include -I$(DISTORM3_DIR)/include
LIBS = @LIBS@
LINK_SHARED = @LINK_SHARED@

@IF_WIN32@LIBS += -lpsapi
@IF_OSX@LDFLAGS += -install_name @rpath/libduckhook.dylib

DUCKHOOK_OBJS = \
	os_func.o \
	duckhook.o \
	duckhook_x86.o \
	duckhook_@DUCKHOOK_OS@.o

DISTORM3_OBJS = \
	mnemonics.o \
	wstring.o \
	textdefs.o \
	prefix.o \
	operands.o \
	insts.o \
	instructions.o \
	distorm.o \
	decoder.o

HEADERS = \
	duckhook.h \
	duckhook_internal.h \
	os_func.h

OBJS = $(DUCKHOOK_OBJS) $(DISTORM3_OBJS)

all: @LIBDUCKHOOK_SO@

check:
	cd ../test && $(MAKE) check

@LIBDUCKHOOK_SO@: $(OBJS)
	$(LINK_SHARED) $(LDFLAGS) -o @LIBDUCKHOOK_SO@ $(OBJS) $(LIBS)

duckhook.o: duckhook.c $(HEADERS)
duckhook_linux.o: duckhook_linux.c $(HEADERS)
duckhook_windows.o: duckhook_windows.c $(HEADERS)
duckhook_x86.o: duckhook_x86.c $(HEADERS)
os_func.o: os_func.c os_func.h

# suppress warning: missing braces around initializer [-Wmissing-braces]
insts.o: insts.c
	$(CC) $(CFLAGS) -c -o insts.o $(DISTORM3_DIR)/src/insts.c -Wno-missing-braces

clean:
	$(RM) @LIBDUCKHOOK_SO@ $(OBJS)

Makefile config.h: $(srcdir)/Makefile.in $(srcdir)/config.h.in $(top_builddir)/config.status
	cd $(top_builddir) && ./config.status
