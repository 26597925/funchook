srcdir = @srcdir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

CC = @CC@
AS = @CC@ -c
OBJS = test_main.o @DUCKHOOK_CPU@_test.o
CFLAGS += -O2 -g -I$(srcdir)/../include
PIC_CFLAGS = @PIC_CFLAGS@
LIBS = -L$(top_builddir)/src -lduckhook -Wl,-rpath,$(top_builddir)/src -L. -lduckhook_test -Wl,-rpath,.
LINK_SHARED = @LINK_SHARED@
EXEEXT = @EXEEXT@
DLLTOOL = $(CC:gcc=dlltool)
@IF_WIN32@ OUT_IMPLIB = -Wl,--out-implib,duckhook_test.lib
@IF_WIN32@ DUCKHOOK_TEST_LIB = duckhook_test_exe.lib

VPATH = $(srcdir):../src

all: duckhook_test$(EXEEXT)

test: duckhook_test$(EXEEXT)
	@IF_WIN32@ cmp -s $(top_builddir)/src/duckhook.dll duckhook.dll || cp $(top_builddir)/src/duckhook.dll duckhook.dll
	./duckhook_test$(EXEEXT)

duckhook_test$(EXEEXT): $(OBJS) @LIBDUCKHOOK_SO@ libduckhook_test.so
	$(CC) -o duckhook_test$(EXEEXT) $(OBJS) $(LIBS)

libduckhook_test.so: $(srcdir)/libduckhook_test.c $(DUCKHOOK_TEST_LIB)
	$(LINK_SHARED) $(PIC_CFLAGS) $(CFLAGS) -o libduckhook_test.so $(srcdir)/libduckhook_test.c $(OUT_IMPLIB) $(DUCKHOOK_TEST_LIB)

clean:
	$(RM) $(TESTEXE) *.o libduckhook_test.so

Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	cd $(top_builddir) && ./config.status

duckhook_test_exe.lib:
	echo "LIBRARY duckhook_test.exe" > duckhook_test_exe.def
	echo "EXPORTS" >> duckhook_test_exe.def
	echo "get_val_in_exe" >> duckhook_test_exe.def
	$(DLLTOOL) -d duckhook_test_exe.def -l duckhook_test_exe.lib
